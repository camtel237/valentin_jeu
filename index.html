<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Un Message pour Toi ğŸ’Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: manipulation; overflow-x: hidden; font-family: 'Segoe UI', sans-serif; }
        .glass { backdrop-filter: blur(15px); background: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.4); }
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100% { transform: translateY(0px); } 50% { transform: translateY(-12px); } }
        
        .scroll-text {
            animation: scrollUp 10s linear forwards; 
            position: relative;
            top: 100%;
        }
        @keyframes scrollUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(-120%); }
        }
        
        /* Classe pour activer le scroll manuel Ã  la fin */
        .scroll-active { overflow-y: auto !important; }

        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .hidden { display: none !important; }
        .active-tab { background-color: #e11d48 !important; color: white !important; }

        
    </style>
</head>
<body class="bg-gradient-to-br from-pink-200 via-rose-100 to-red-200 min-h-screen flex items-center justify-center p-4">

<audio id="bgMusic" loop><source src="https://cdn.pixabay.com/audio/2022/03/15/audio_4c8f68b5c6.mp3"></audio>

<div id="setupScreen" class="glass shadow-2xl rounded-[2.5rem] p-8 w-full max-w-lg text-center animate-pop border-4 border-white hidden">
    <h1 class="text-3xl font-black text-rose-600 mb-2 uppercase tracking-tighter italic">CrÃ©er ton Message ğŸ’Œ</h1>
    
    <div class="flex gap-2 mb-6 bg-white/50 p-1 rounded-2xl">
        <button onclick="switchTab('love')" id="tab-love" class="flex-1 py-3 rounded-xl font-bold text-xs active-tab transition-all">ğŸ’• AMOUREUX</button>
        <button onclick="switchTab('family')" id="tab-family" class="flex-1 py-3 rounded-xl font-bold text-xs bg-transparent transition-all">ğŸ  FAMILLE / AMIS</button>
    </div>

    <div id="form-love" class="space-y-4 text-left">
        <div class="grid grid-cols-2 gap-3">
            <input id="fromLove" type="text" placeholder="Ton nom" class="w-full p-4 rounded-2xl border-none shadow-inner outline-none focus:ring-2 focus:ring-rose-400">
            <input id="toLove" type="text" placeholder="Son nom" class="w-full p-4 rounded-2xl border-none shadow-inner outline-none focus:ring-2 focus:ring-rose-400">
        </div>
        <div class="flex gap-2">
            <button onclick="setGender('f')" id="btnF" class="flex-1 p-3 rounded-xl border-2 border-rose-500 bg-rose-500 text-white font-bold text-[10px] uppercase">Valentine ğŸ‘—</button>
            <button onclick="setGender('m')" id="btnM" class="flex-1 p-3 rounded-xl border-2 border-rose-500 text-rose-500 bg-white font-bold text-[10px] uppercase">Valentin ğŸ‘”</button>
        </div>
        <textarea id="msgLove" rows="3" placeholder="Ton message secret..." class="w-full p-4 rounded-2xl border-none shadow-inner outline-none focus:ring-2 focus:ring-rose-400 resize-none"></textarea>
    </div>

    <div id="form-family" class="space-y-4 text-left hidden">
        <div class="grid grid-cols-2 gap-3">
            <input id="fromFam" type="text" placeholder="Ton nom" class="w-full p-4 rounded-2xl border-none shadow-inner outline-none focus:ring-2 focus:ring-rose-400">
            <input id="toFam" type="text" placeholder="Nom du parent/ami" class="w-full p-4 rounded-2xl border-none shadow-inner outline-none focus:ring-2 focus:ring-rose-400">
        </div>
        <textarea id="msgFam" rows="5" placeholder="Ton message long..." class="w-full p-4 rounded-2xl border-none shadow-inner outline-none focus:ring-2 focus:ring-rose-400 resize-none"></textarea>
    </div>

    <button onclick="generateLink()" class="w-full mt-8 bg-rose-600 text-white py-5 rounded-3xl font-black shadow-xl hover:bg-rose-700 transition-all uppercase tracking-widest">GÃ©nÃ©rer & Copier le lien</button>
</div>

<div id="successModal" class="fixed inset-0 bg-black/60 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm text-center shadow-2xl animate-pop border-4 border-pink-200">
        <h3 class="text-2xl font-black text-rose-500 mb-2 uppercase">C'est prÃªt !</h3>
        <p class="text-gray-500 text-sm mb-6 font-medium">Le lien a Ã©tÃ© copiÃ©. Envoie-le vite ! ğŸ’–</p>
        <button onclick="closeSuccessModal()" class="w-full bg-rose-500 text-white py-4 rounded-2xl font-black shadow-lg uppercase">Super !</button>
    </div>
</div>

<div id="loveGame" class="glass shadow-2xl rounded-[2rem] p-6 w-full max-w-md text-center relative border border-white/40 hidden">
    <h1 class="text-xl font-extrabold text-rose-600 mb-4 uppercase italic">ğŸ“© De <span id="loveFrom">...</span></h1>
    <img id="bearImage" src="happy1.jpeg" class="w-full h-64 object-cover rounded-2xl shadow-lg floating border-4 border-white mb-4 transition-all duration-500">
    <p id="lovePrompt" class="mb-6 text-gray-800 text-lg font-medium italic">Accepterais-tu d'Ãªtre <span id="lovePossessive">ma</span> <span id="loveTarget" class="font-bold text-rose-600 underline">Valentine</span> ? ğŸ’Œ</p>
    <div id="buttonZone" class="relative flex justify-center items-center gap-4 h-24">
        <button id="yesBtn" class="bg-red-500 text-white px-8 py-3 rounded-full font-black shadow-lg z-50 transition-transform">ğŸ’– OUI</button>
        <button id="noBtn" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-full font-bold shadow-md">ğŸ’” NON</button>
    </div>
    <div id="finalScreen" class="hidden space-y-3">
        <h2 class="text-2xl font-black text-red-500 uppercase animate-bounce">Je savais que tu allais dire oui ! ğŸ˜</h2>
        <button onclick="showLetterFromGame()" class="w-full bg-rose-500 text-white p-4 rounded-2xl font-black shadow-lg">ğŸ“– LIRE MA LETTRE</button>
        <button onclick="resetToHome()" class="w-full bg-gray-100 text-gray-500 p-3 rounded-2xl font-bold text-sm">ğŸ“¤ CRÃ‰ER LE MIEN</button>
    </div>
</div>

<div id="familyLetter" class="glass shadow-2xl rounded-[2.5rem] p-2 w-full max-w-md text-center border-4 border-white h-[85vh] flex flex-col overflow-hidden hidden">
    <div class="bg-rose-500 p-4 rounded-t-[2rem] text-white font-black uppercase italic">ğŸ’Œ Pour : <span id="familyTo">...</span> âœ¨</div>
    <div id="letterBody" class="flex-grow relative overflow-hidden p-6 flex flex-col items-center">
        <div id="scroller" class="scroll-text text-gray-800 text-2xl font-serif italic leading-relaxed text-center"></div>
        <div id="letterEnd" class="p-6 w-full hidden animate-pop">
            <p class="text-rose-600 font-black mb-4 italic uppercase border-t border-rose-200 pt-4">SignÃ© : <span id="familyFrom">...</span> ğŸ’–</p>
            <button onclick="resetToHome()" class="w-full bg-rose-500 text-white p-4 rounded-2xl font-bold shadow-lg">ğŸ“¤ ENVOYER AUSSI</button>
        </div>
    </div>
</div>

<script>
    // --- PrÃ©chargement des images ---
    const imagesToPreload = ["sad1.jpeg", "sad2.jpeg", "sad3.jpeg", "sad4.jpeg", "cony-brown.gif", "my-lover.gif", "happy1.jpeg"];

    imagesToPreload.forEach(image => {
        const img = new Image();
        img.src = image;
    });
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    let selectedGender = 'f';
    let currentTab = 'love';

    window.onload = () => {
        if (!mode) document.getElementById('setupScreen').classList.remove('hidden');
        else if (mode === 'love') setupLoveGame();
        else if (mode === 'family') setupFamilyLetter();
    };

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-love').className = tab === 'love' ? 'flex-1 py-3 rounded-xl font-bold text-xs active-tab' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-transparent';
        document.getElementById('tab-family').className = tab === 'family' ? 'flex-1 py-3 rounded-xl font-bold text-xs active-tab' : 'flex-1 py-3 rounded-xl font-bold text-xs bg-transparent';
        document.getElementById('form-love').classList.toggle('hidden', tab !== 'love');
        document.getElementById('form-family').classList.toggle('hidden', tab !== 'family');
    }

    function setGender(g) {
        selectedGender = g;
        document.getElementById('btnF').className = g === 'f' ? 'flex-1 p-3 rounded-xl border-2 border-rose-500 bg-rose-500 text-white font-bold text-[10px] uppercase' : 'flex-1 p-3 rounded-xl border-2 border-rose-500 text-rose-500 bg-white font-bold text-[10px] uppercase';
        document.getElementById('btnM').className = g === 'm' ? 'flex-1 p-3 rounded-xl border-2 border-rose-500 bg-rose-500 text-white font-bold text-[10px] uppercase' : 'flex-1 p-3 rounded-xl border-2 border-rose-500 text-rose-500 bg-white font-bold text-[10px] uppercase';
    }

    function generateLink() {
     let from, to, msg;
        if(currentTab === 'love') {
            from = document.getElementById('fromLove').value;
            to = document.getElementById('toLove').value;
            msg = document.getElementById('msgLove').value;
        } else {
            from = document.getElementById('fromFam').value;
            to = document.getElementById('toFam').value;
            msg = document.getElementById('msgFam').value;
        }

        // POPUPS DE VERIFICATION SPECIFIQUES
        if(!from) return alert("HÃ© ! Tu as oubliÃ© de dire qui tu es (Ton nom). ğŸ§¸");
        if(!to) return alert("A qui est destinÃ© ce message ? Remplis le nom ! ğŸ§¸");
        if(!msg) return alert("Le message est vide ! Ã‰cris quelque chose de gentil. âœ¨");

        const baseUrl = window.location.origin + window.location.pathname;
        // On compresse le message avec btoa (Base64) pour qu'il soit plus court et "codÃ©"
        const compressedMsg = btoa(unescape(encodeURIComponent(msg)));

        let finalUrl = `${baseUrl}?m=${currentTab}&f=${encodeURIComponent(from)}&t=${encodeURIComponent(to)}&s=${compressedMsg}`;        if(currentTab === 'love') finalUrl += `&gender=${selectedGender}`;

        navigator.clipboard.writeText(finalUrl).then(() => {
            document.getElementById('successModal').classList.remove('hidden');
        });
    }

    function setupLoveGame() {
        document.getElementById('loveGame').classList.remove('hidden');
        document.getElementById('loveFrom').textContent = urlParams.get('from');
        const g = urlParams.get('gender') || 'f';
        document.getElementById('loveTarget').textContent = g === 'm' ? 'Valentin' : 'Valentine';
        document.getElementById('lovePossessive').textContent = g === 'm' ? 'mon' : 'ma';

        const yesBtn = document.getElementById('yesBtn');
        const noBtn = document.getElementById('noBtn');
        const bearImg = document.getElementById('bearImage');
        const sadImages = ["sad1.jpeg", "sad2.jpeg", "sad3.jpeg", "sad4.jpeg"];
        const noTexts = ["SÃ»r(e) ?", "RÃ©flÃ©chis...", "Vraiment ?", "ğŸ˜¢", "Allez...", "S'il te plait"];
        let refusCount = 0; 
        let scale = 1;

        noBtn.addEventListener('click', () => {
            refusCount++;
            scale += 0.4;
            yesBtn.style.transform = `scale(${scale})`;
            yesBtn.style.zIndex = "100";

            let imgIndex = Math.min(refusCount - 1, sadImages.length - 1);
            bearImg.src = sadImages[imgIndex];

            let textIndex = Math.min(refusCount - 1, noTexts.length - 1);
            noBtn.textContent = noTexts[textIndex];

            const x = Math.random() * (window.innerWidth - 120);
            const y = Math.random() * (window.innerHeight - 120);
            noBtn.style.position = 'fixed';
            noBtn.style.left = x + 'px';
            noBtn.style.top = y + 'px';

            if(refusCount >= 12) noBtn.style.display = 'none';
        });

        yesBtn.addEventListener('click', () => {
            bearImg.src = (g === "m") ? "cony-brown.gif" : "my-lover.gif";
            document.getElementById('buttonZone').classList.add('hidden');
            document.getElementById('lovePrompt').classList.add('hidden');
            document.getElementById('finalScreen').classList.remove('hidden');
        });
    }

    function setupFamilyLetter() {
       document.getElementById('familyLetter').classList.remove('hidden');
        document.getElementById('familyTo').textContent = urlParams.get('t');
        document.getElementById('familyFrom').textContent = urlParams.get('f');
        
        try {
            const decoded = decodeURIComponent(escape(atob(urlParams.get('s'))));
            document.getElementById('scroller').textContent = decoded;
        } catch(e) { document.getElementById('scroller').textContent = urlParams.get('s'); }
        
        // GESTION DU SCROLL ET DE LA SIGNATURE
        setTimeout(() => {
            const letterEnd = document.getElementById('letterEnd');
            const scroller = document.getElementById('scroller');
            const letterBody = document.getElementById('letterBody');

            letterEnd.classList.remove('hidden'); 
            letterBody.classList.add('scroll-active');
            
            scroller.style.animation = "none";
            scroller.style.top = "0";

            // Descendre doucement vers la signature
            letterBody.scrollTo({ top: letterBody.scrollHeight, behavior: 'smooth' });
        }, 10000); 
    }

    function showLetterFromGame() {
        document.getElementById('loveGame').classList.add('hidden');
        setupFamilyLetter();
    }

    function resetToHome() { window.location.href = window.location.origin + window.location.pathname; }
    function closeSuccessModal() {
        // 1. On cache la modal
        document.getElementById('successModal').classList.add('hidden');
        
        // 2. On redirige vers une page vide ("about:blank") 
        // ou vers l'accueil vide du site
        window.location.href = "about:blank"; 
    }
    document.addEventListener('click', () => {
        const audio = document.getElementById('bgMusic');
        if(audio.paused) { audio.volume = 0.2; audio.play(); }
    }, {once: true});
</script>
</body>

</html>

